---
import DefaultSocialIcons from '@astrojs/starlight/components/SocialIcons.astro';

const repoOwner = 'NSPC911';
const repoName = 'rovr';
---

<div class="social-wrapper">
  <div class="github-stats" hidden>
    <a href={`https://github.com/${repoOwner}/${repoName}/network/members`} class="github-stat" title="Release">
      <span>󰓼</span>
      <span>󰓹</span>
      <span id="gh-release">v0.7.0.dev2</span>
    </a>

    <a href={`https://github.com/${repoOwner}/${repoName}/stargazers`} class="github-stat" title="Stars">
      <span></span>
      <span></span>
      <span id="gh-stars">104</span>
    </a>

    <a href={`https://github.com/${repoOwner}/${repoName}/network/members`} class="github-stat" title="Forks">
      <span></span>
      <span></span>
      <span id="gh-forks">17</span>
    </a>
  </div>

  <DefaultSocialIcons><slot /></DefaultSocialIcons>
</div>

<script>
  const REPO_OWNER = 'NSPC911';
  const REPO_NAME = 'rovr';
  const CACHE_TTL = 24 * 60 * 60 * 1000;

  interface CachedStats {
    stars: number;
    forks: number;
    release_tag: string;
    timestamp: number;
  }

  function getCacheKey(): string {
    const isDev = window.location.pathname.includes('/dev');
    return `github-stats-${isDev ? 'dev' : 'stable'}`;
  }

  function getCachedStats(): CachedStats | null {
    try {
      const cached = localStorage.getItem(getCacheKey());
      if (!cached) return null;
      return JSON.parse(cached) as CachedStats;
    } catch {
      return null;
    }
  }

  function setCachedStats(stats: Omit<CachedStats, 'timestamp'>): void {
    try {
      const data: CachedStats = { ...stats, timestamp: Date.now() };
      localStorage.setItem(getCacheKey(), JSON.stringify(data));
    } catch {}
  }

  function updateDOM(stars: number, forks: number, release_tag: string): void {
    const starsEl = document.getElementById('gh-stars');
    const forksEl = document.getElementById('gh-forks');
    const releaseEl = document.getElementById('gh-release');

    if (starsEl) starsEl.textContent = String(stars);
    if (forksEl) forksEl.textContent = String(forks);
    if (releaseEl) releaseEl.textContent = release_tag;

    document.querySelector('.github-stats')?.removeAttribute('hidden');
  }

  async function fetchRealGithubStats(): Promise<Omit<CachedStats, 'timestamp'> | null> {
    try {
      const [repoRes, releasesRes] = await Promise.all([
        fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`),
        fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases`)
      ]);
      if (!repoRes.ok) return null;

      const repo = await repoRes.json();
      const releases = releasesRes.ok ? await releasesRes.json() : [];

      return {
        stars: repo.stargazers_count,
        forks: repo.forks_count,
        release_tag: releases.length > 0 ? releases[0].tag_name : 'latest'
      };
    } catch {
      return null;
    }
  }

  async function fetchGitHubStats(): Promise<Omit<CachedStats, 'timestamp'> | null> {
    try {
      const [repoRes, releaseRes] = await Promise.all([
        fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`),
        fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest`)
      ]);

      if (!repoRes.ok) return null;

      const repo = await repoRes.json();
      const release = releaseRes.ok ? await releaseRes.json() : null;

      const release_tag = release?.tag_name || 'latest';

      return {
        stars: repo.stargazers_count,
        forks: repo.forks_count,
        release_tag
      };
    } catch {
      return null;
    }
  }

  async function fetchAndUpdate(): Promise<void> {
    const cached = getCachedStats();
    const now = Date.now();

    if (cached && (now - cached.timestamp) < CACHE_TTL) {
      updateDOM(cached.stars, cached.forks, cached.release_tag);
      return;
    }

    let fresh
    if (window.location.pathname.includes('/dev')) {
      fresh = await fetchRealGithubStats();
    } else {
      fresh = await fetchGitHubStats();
    }

    if (fresh) {
      setCachedStats(fresh);
      updateDOM(fresh.stars, fresh.forks, fresh.release_tag);
    } else if (cached) {
      updateDOM(cached.stars, cached.forks, cached.release_tag);
    }
  }

  fetchAndUpdate();
</script>

<style>
  .social-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    > .sl-flex {
      color: var(--sl-color-text);
    }
  }

  .github-stats {
    display: flex;
    align-items: center;
    padding: 0.2rem 0.8rem;
    border-radius: 9999px;
    background-color: var(--sl-color-bg-sidebar);
  }

  .github-stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--sl-color-text);
    text-decoration: none;
  }
  [hidden] {
    display: none !important
  }
</style>
